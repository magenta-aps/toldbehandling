{% extends extend_template %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% load common_tags %}

{% block content %}
<form method="post" class="needs-validation" novalidate>
    {% csrf_token %}

    <div class="content">
        {% if form.errors %}
        <div class="alert alert-danger">
            <ul class="errorlist nonfield">
            {% for field in form.errors %}
            {% for error in form.errors|get:field %}
            <li>
                {{error}}
            </li>
            {% endfor %}
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-6">
                <h1 class="mb-3">
                    {% blocktranslate with id=object.id|unlocalize %}Afgiftsanmeldelse {{id}}{% endblocktranslate %}
                </h1>
                {% include "told_common/status.html" with item=object %}
            </div>
            <div class="col-6 text-end">
                {# Object actions #}

                {% if can_godkend %}
                {% if object.status == "ny" or object.status == "afvist" %}
                <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#godkend_modal">
                    <span class="material-icons">check</span>
                    <span>{% translate "Godkend" %}</span>
                </button>
                {% endif %}
                {% endif %}

                {% if can_afvis %}
                {% if object.status == "ny" %}
                <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#afvis_modal">
                    <span class="material-icons">cancel</span>
                    <span>{% translate "Afvis" %}</span>
                </button>
                {% endif %}
                {% endif %}

                {% if can_godkend or can_afvis %}
                {% if object.status == "godkendt" or object.status == "afvist" %}
                <button type="submit" name="{{form.status.name}}" value="ny" class="btn btn-secondary me-2">
                    <span class="material-icons">cancel</span>
                    {% if object.status == "godkendt" %}
                    {% translate "Annullér godkendelse" %}
                    {% elif object.status == "afvist" %}
                    {% translate "Annullér afvisning" %}
                    {% endif %}
                </button>
                {% endif %}
                {% endif %}

                {% if can_edit %}
                {% if object.status == "ny" or object.status == "kladde" or object.status == "afvist" %}
                <a href="{% url 'tf10_edit' id=object.id %}?back=view" class="btn btn-secondary me-2">
                    <span class="material-icons">edit</span>
                    <span>{% translate "Redigér" %}</span>
                </a>
                {% endif %}

                {% if not admin_ui and object.status == "afvist" %}
                <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#genindsend_modal">
                    <span class="material-icons">send</span>
                    <span>{% translate "Genindsend" %}</span>
                </button>
                {% endif %}
                {% endif %}

                {% if can_send_prisme %}
                {% if object.status == "godkendt" or object.status == "afsluttet" %}
                {% if object.status == "afsluttet" %}
                <button type="button" class="btn btn-secondary me-2 disabled">
                    <span class="material-icons">send</span>
                    <span>{% translate "Send til Prisme" %}</span>
                </button>
                {% else %}
                <button type="button" class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#prisme_modal">
                    <span class="material-icons">send</span>
                    <span>{% translate "Send til Prisme" %}</span>
                </button>
                {% endif %}
                {% endif %}
                {% endif %}

                {% if can_view_history %}
                <a href="{% url 'tf10_history' id=object.id %}" class="btn btn-secondary me-2">
                    <span class="material-icons">history</span>
                    <span>{% translate "Historik" %}</span>
                </a>
                {% endif %}
            </div>
        </div>

        <h4 class="my-3">{% translate "For indførsel af afgiftspligtige varer i Grønland" %}</h4>

        <div class="row">
            <div class="col-2">
                <label>{% translate "Oprettelsesdato" %}:</label>
            </div>
            <div class="col-10">
                {{object.dato}}
            </div>
        </div>

        <hr/>

        {% localize off %}
        <div class="row">
            <div class="col-6">
                <h5 class="mb-3">{% translate "Afsender" %}</h5>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "CVR" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.afsender.cvr|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Navn" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.afsender.navn|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Adresse" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.afsender.adresse|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Postbox" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.afsender.postbox|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Postnummer" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.afsender.postnummer|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "By" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.afsender.by|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Telefon" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.afsender.telefon|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Indførselstilladelse" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.indførselstilladelse|default_if_none:""}}
                    </div>
                </div>
            </div>

            <div class="col-6">
                <h5 class="mb-3">{% translate "Modtager" %}</h5>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "CVR" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.modtager.cvr|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Navn" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.modtager.navn|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Adresse" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.modtager.adresse|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Postbox" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.modtager.postbox|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Postnummer" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.modtager.postnummer|default_if_none:""}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "By" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.modtager.by|default_if_none:""}}
                    </div>
                </div>
                {% if show_stedkode %}
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Stedkode" %}:</label>
                    </div>
                    <div class="col-8">
                        {% if object.modtager.stedkode %}
                        {{object.modtager.stedkode|zfill:3}}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Telefon" %}:</label>
                    </div>
                    <div class="col-8">
                        {{object.modtager.telefon|default_if_none:""}}
                    </div>
                </div>
            </div>
        </div>

        {% endlocalize %}

        <hr/>

        <h5 class="mb-3">{% translate "Oplysninger om fragt" %}</h5>

        <div class="row">
            <div class="col-6">
                <div class="row">
                    <div class="col-4">
                        <label>Leverandørfaktura&shy;nummer:</label>
                    </div>
                    <div class="col-8">
                        {{object.leverandørfaktura_nummer}}
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Leverandørfaktura" %}:</label>
                    </div>
                    <div class="col-8">
                        <a href="{% url 'leverandørfaktura_view' id=object.id %}">
                            {{object.leverandørfaktura|file_basename}}
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Fragtbrev" %}:</label>
                    </div>
                    <div class="col-8">
                        {% if object.fragtforsendelse.fragtbrev %}
                        <a href="{% url 'fragtbrev_view' id=object.fragtforsendelse.id %}">
                            {{object.fragtforsendelse.fragtbrev|file_basename}}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-6">
                <div class="row">
                    <div class="col-4">
                        <label>{% translate "Forsendelsesmåde" %}:</label>
                    </div>
                    <div class="col-8">
                        {% if object.fragtforsendelse.forsendelsestype.name == "SKIB" %}
                        {% translate "Skibsfragt" %}
                        {% elif object.fragtforsendelse.forsendelsestype.name == "FLY" %}
                        {% translate "Luftfragt" %}
                        {% elif object.postforsendelse.forsendelsestype.name == "SKIB" %}
                        {% translate "Skibspost" %}
                        {% elif object.postforsendelse.forsendelsestype.name == "FLY" %}
                        {% translate "Luftpost" %}
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-4">
                        {% if object.fragtforsendelse %}
                        {% translate "Forbindelsesnr." %}:
                        {% elif object.postforsendelse %}
                        {% translate "Afsenderby­kode" %}:
                        {% endif %}
                    </div>
                    <div class="col-8">
                        {% if object.fragtforsendelse %}
                            {{object.fragtforsendelse.forbindelsesnr}}
                        {% elif object.postforsendelse %}
                            {{object.postforsendelse.afsenderbykode}}
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-4">
                        {% if object.fragtforsendelse %}
                        {% translate "Fragtbrevnr." %}
                        {% elif object.postforsendelse %}
                        {% translate "Post­forsendelses­nr." %}:
                        {% endif %}
                    </div>
                    <div class="col-8">
                        {% if object.fragtforsendelse %}
                        {{object.fragtforsendelse.fragtbrevsnummer}}
                        {% elif object.postforsendelse %}
                        {{object.postforsendelse.postforsendelsesnummer}}
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-4">
                        {% translate "Afgangsdato" %}:
                    </div>
                    <div class="col-8">
                        {% if object.fragtforsendelse %}
                            {{object.fragtforsendelse.afgangsdato}}
                        {% elif object.postforsendelse %}
                            {{object.postforsendelse.afgangsdato}}
                        {% endif %}
                    </div>
                </div>

                <div class="row">
                    <div class="col-4">
                        {% translate "Beregnet faktureringsdato" %}:
                    </div>
                    <div class="col-8">
                        {{object.beregnet_faktureringsdato}}
                    </div>
                </div>
            </div>
        </div>

        <hr/>

        <h5 class="mb-3">{% translate "Varelinjer med afgifter" %}</h5>

        <table class="table table-light">
            <thead>
            <tr>
                <th class="col-2">
                    {% translate "Vareart" %}
                </th>
                <th class="col-2">
                    {% translate "Varekode" %}
                </th>
                <th class="col-1">
                    {% translate "kg | liter" %}
                </th>
                <th class="col-1">
                    {% translate "Antal" %}
                </th>
                <th class="col-2">
                    {% translate "Fakturabeløb" %}
                </th>
                <th class="col-2">
                    {% translate "Afgiftssats" %}
                </th>
                <th class="col-2">
                    {% translate "Afgiftsbeløb" %}
                </th>
            </tr>
            </thead>
            <tbody>

            {% for varelinje in object.varelinjer %}
            {% with varelinje.vareafgiftssats as sats %}
            <tr>
                <td class="col-2">
                    {% get_current_language as LANGUAGE_CODE %}
                    {% if LANGUAGE_CODE == "kl" %}
                    {{sats.vareart_kl}}
                    {% else %}
                    {{sats.vareart_da}}
                    {% endif %}
                </td>
                <td class="col-2">
                    {{sats.afgiftsgruppenummer|zfill:9}}
                </td>
                <td class="col-1">
                    {{varelinje.mængde|default_if_none:""}}
                </td>
                <!-- TODO: Skal der vises kg/liter eller antal når der er tale om en procentsats eller sammensat sats? -->
                <td class="col-1">
                    {{varelinje.antal|default_if_none:""}}
                </td>
                <td class="col-2">
                    {{varelinje.fakturabeløb|floatformat:2}}
                </td>
                <td class="col-2">
                    {{sats.text}}
                </td>
                <td class="col-2">
                    {{varelinje.afgiftsbeløb|floatformat:2}}
                </td>
            </tr>
            {% endwith %}
            {% endfor %}

            </tbody>

            <tfoot>
                <tr>
                    <td colspan="5"></td>
                    <td class="px-3"><strong>{% translate "Afgift i alt" %}</strong></td>
                    <td class="px-3">{{object.afgift_sum}}</td>
                </tr>
            </tfoot>
        </table>

        <h5 class="mb-3">{% translate "Indberetter(e)" %}</h5>

        <table class="table table-light">
            <thead>
                <tr>
                    <th class="col-2">{% translate "Type" %}</th>
                    <th class="col-2">{% translate "Navn" %}</th>
                    <th class="col-4">CVR</th>
                </tr>
            </thead>
            <tbody>
                {% for indberetter in indberettere %}
                <tr>
                    <td>{{indberetter.type}}</td>
                    <td>{{indberetter.navn}}</td>
                    <td>
                        {% if indberetter.cvr %}
                            {{indberetter.cvr|stringformat:"s"}}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h5 class="mb-3">{% translate "Notater" %}</h5>

        {% include "told_common/notat/list.html" with notater=object.notater %}

        <h5 class="mb-3">{% translate "Betaling" %}</h5>

        <table class="table table-light">
            <thead>
                <tr>
                    <th class="col-2">{% translate "Toldkategori" %}</th>
                    <th class="col-2">{% translate "Betales af" %}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        {% translate "Ikke angivet" as ikke_angivet %}
                        {{object.toldkategori|default:ikke_angivet}}
                    </td>
                    <td>
                        {% if object.betales_af == 'afsender'  %}
                            {% translate "Afsender" %}
                        {% elif object.betales_af == 'modtager' %}
                            {% translate "Modtager" %}
                        {% elif object.betales_af == 'indberetter' %}
                            {% translate "Indberetter" %}
                        {% else %}
                            {% translate "Ikke tilgængelig" %}
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="modal" id="godkend_modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Godkend afgiftsanmeldelse</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Er du sikker på at du vil godkende afgiftsanmeldelsen?</p>
                    {{form.notat1}}
                </div>
                <div class="modal-footer">
                    <button type="submit" name="{{form.status.name}}" value="godkendt" class="btn btn-success">
                        <span class="material-icons">check</span>
                        <span>{% translate "Godkend" %}</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% translate "Annuller" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="afvis_modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Afvis afgiftsanmeldelse</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        {% translate "Skriv en begrundelsen for afvisningen herunder." %}<br />
                        {% translate "Denne begrundelse vil blive sendt til indberetteren pr. email." %}
                    </p>
                    {{form.notat2}}
                    <div class="invalid-feedback">
                        {% translate "Afgiftsanmeldelser kan ikke afvises uden et notat" %}
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex align-items-center">
                        <div class="col-7">
                            <span>{% translate "Er du sikker på, du vil afvise denne afgiftsanmeldelse?" %}</span>
                        </div>
                        <div class="col-5 text-end">
                            <button type="submit" name="{{form.status.name}}" value="afvist" class="btn btn-danger">
                                <span class="material-icons">cancel</span>
                                <span>{% translate "Afvis" %}</span>
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuller</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="genindsend_modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Genindsend afgiftsanmeldelse</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>{% translate "Er du sikker på du vil genindsende afgiftsanmeldelse" %} {{id}} ?</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="{{form.status.name}}" class="btn btn-primary" value="ny">
                        <span class="material-icons">send</span>
                        <span>Genindsend</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuller</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="prisme_modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send afgiftsanmeldelse til Prisme</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Er du sikker på at du vil sende afgiftsanmeldelsen til Prisme?</p>
                    <div class="row">
                        <div class="col-12">
                            {{form.notat3}}
                        </div>
                    </div>

                    <div class="row align-items-center">
                        <div class="col-4">
                            <label for="{{form.toldkategori.id_for_label}}">{{form.toldkategori.label}}*</label>
                        </div>
                        <div class="col-8">
                            {{form.toldkategori}}
                        </div>
                    </div>

                    <div class="row align-items-center">
                        <div class="col-4">
                            <label for="{{form.modtager_stedkode.id_for_label}}">{{form.modtager_stedkode.label}}*</label>
                        </div>
                        <div class="col-8">
                            {{form.modtager_stedkode}}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" name="{{form.send_til_prisme.name}}" value="true" class="btn btn-primary">
                        <span class="material-icons">send</span>
                        <span>Send til Prisme</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuller</button>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
    <div class="modal" id="message_modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Returstatus</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% for message in messages %}
                    {{ message|linebreaks }}
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    <script nonce="{{ request.csp_nonce }}">
        const modal = new bootstrap.Modal('#message_modal', {});
        modal.show();
    </script>
    {% endif %}

</form>

<script nonce="{{ request.csp_nonce }}">
    // MODAL hide/show configs
    $(".modal").on("show.bs.modal", function () {
        $(this).find("input,select,textarea").removeAttr("disabled");
        $(this).find("[data-modal-required=true]").attr("required", "required");
    });
    $(".modal").on("hide.bs.modal", function () {
        $(this).find("input,select,textarea").attr("disabled", "disabled");
        $(this).find("[data-modal-required=true]").removeAttr("required");

        // Reset form validation
        $(this).parents("form.was-validated").removeClass("was-validated")
    });

    // Form validation
    $(".needs-validation").on("submit", function (e) {
        if (!this.checkValidity()) {
            e.preventDefault()
            event.stopPropagation()
        }

        $(this).addClass('was-validated')
    })
</script>
{% endblock %}
